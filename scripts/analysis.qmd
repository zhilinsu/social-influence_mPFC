---
title: "Dorsomedial and ventromedial prefrontal cortex lesions differentially impact social influence and temporal impulsivity"
author: "Zhilin Su"
date: "2025"
date-format: "YYYY"
format: html
page-layout: full 
toc: true
toc-depth: 6
embed-resources: true 
theme: default
mainfont: Roboto 
fontsize: 12pt 
execute: 
  cache: true
---

# 0-1. Preparation 

```{r}
#| label: setting 
#| echo: false 
#| warning: false 

# Clear up 
rm(list = ls())

# Whether to re-save results? 0 for no; 1 for yes. 
is_save <- 0
```

```{r}
#| label: libraries  
#| echo: false 
#| warning: false 

# Load libraries ---- 
## Data wrangling 
library(dplyr)
library(readr)
library(forcats)
library(stringr)

## Visualisation 
library(ggplot2)
library(ggpubr)
library(ggtext) # to format the annotations on plots 
library(ggpattern)
library(ggsignif)
library(grid) # to control the grid parameters 
library(gridExtra)
library(patchwork)

## Statistics & modelling 
library(rstatix)
library(lme4)
library(lmerTest)
library(Hmisc) # rcorr
library(sjPlot)
library(parameters)
library(performance)
library(arm)
library(BayesFactor) 
library(emmeans)
library(effectsize) 
library(statpsych)

## Others 
library(finalfit) # p_tidy() 
library(kableExtra) 
library(mixedpower) # power analysis 
source("scripts/helper_functions/helper_functions.R")
source("scripts/helper_functions/rankBasedCommonFunctions.R")
source("scripts/helper_functions/spearmanSampler.R")
```

```{r}
#| label: plot_setting 
#| echo: false 
#| warning: false 

resolution <- 1200
plot_h <- 4
ax_text <- 12
ax_title <- 16
```

# 0-2. Exclusion 

```{r}
#| label: exclusion 
#| echo: false 
#| warning: false 

excl_id <- c(110, 111, 118, 158, 220, 261, 273)
excl_id_qnr <- c(106, 266)
```

```{r}
#| label: inclusion 
#| echo: false 
#| warning: false 

demogr <- read_csv("data/demographics.csv") |> 
	rename(id = ID_Code, group = `Group SD mPFC`, age = Age, gender = Gender) |> 
	dplyr::select(id, group, age, gender) |> 
	mutate(id = if_else(id == 2012, 299, id))

qnr <- read_csv("data/questionnaires.csv") |>  
		rename(id = ID_Code, 
				 iq = WTAW_Standard, 
				 trail_a = `Trail_Making_A_(seconds)'`, 
				 trail_b = `Trail_Making_B_(seconds)'`, 
				 ami_total = AMI_tot, 
				 ami_ba = AMI_BA, 
				 ami_sm = AMI_SM, 
				 ami_es = AMI_ES, 
				 bdi_total = BDI_total, 
				 edu = Education_years) |>  
	dplyr::select(id, iq, trail_a, trail_b, ami_total, ami_ba, ami_sm, ami_es, bdi_total, edu, 
								SD_similar_p1, SD_similar_p2) |>   
	mutate(id = if_else(id == 2012, 299, id))

inclusion_data <- demogr |>
	left_join(qnr, by = "id") |> 
	filter(!id %in% excl_id)

inclusion_data <- inclusion_data |> 
	filter(group == 3 | group == 4 | (group == 1 & age >= 24 & age <= 76)) |> 
	filter(group == 3 | group == 4 | (group == 1 & trail_b > 40))

# IDs that are included 
incl_id_hc <- inclusion_data |>
	filter(group == 1) |>
	pull(id)

incl_id_mpfc <- inclusion_data |>
	filter(group == 3) |>
	pull(id)

incl_id_lc <- inclusion_data |>
	filter(group == 4) |>
	pull(id)

if (is_save == 1) {
	saveRDS(incl_id_hc, file = "data/incl_id_hc.RDS")
	saveRDS(incl_id_mpfc, file = "data/incl_id_mpfc.RDS")
	saveRDS(incl_id_lc, file = "data/incl_id_lc.RDS")
}
```

# 0-3. Participants

## Healthy controls

71 healthy controls (`Group SD mPFC` label = 1) were included. 

## mPFC lesions

33 mPFC lesion patients (`Group SD mPFC` label = 3) were recruited.

## Lesion controls

17 lesion controls (`Group SD mPFC` label = 4) were recruited.

# 0-4. Data pre-processing 

```{r}
#| label: preprocessing_1 
#| echo: false 
#| warning: false 

# ~~~~ TASK DATA ~~~~ ---- 
# Load data 
load("data/sd_data_mpfc.RData")

sd_data <- abind::abind(sd_hc, sd_mpfc, sd_lc, along = 3)
other_k <- rbind(k_hc, k_mpfc, k_lc)

rm(sd_hc, sd_mpfc, sd_lc, k_hc, k_mpfc, k_lc)

# Convert data type 
other_k <- other_k |>
	as_tibble() |>
	mutate(id = as.numeric(id), 
				 other1_k = as.numeric(other1_k), 
				 other2_k = as.numeric(other2_k), 
				 other1_pref = as.factor(other1_pref), 
				 other2_pref = as.factor(other2_pref)) |>
	# Pre-process the order of others 
	mutate(other_i_k = if_else(other1_pref == "i", other1_k, other2_k), 
				 other_p_k = if_else(other1_pref == "p", other1_k, other2_k))

# Exclude participants
incl_id_hc <- readRDS("data/incl_id_hc.rds")
incl_id_mpfc <- readRDS("data/incl_id_mpfc.rds")
incl_id_lc <- readRDS("data/incl_id_lc.rds")
incl_id <- c(incl_id_hc, incl_id_mpfc, incl_id_lc)

incl_condition <- sd_data[1, "id", ] %in% incl_id 
sd_data <- sd_data[,, incl_condition]
other_k <- other_k |> 
	filter(id %in% incl_id)

# Extract metadata 
## dim(sd_data) = [# trials, # experimental parameters, # participants]
n_trials <- dim(sd_data)[1]
n_pt <- dim(sd_data)[3]

# Reshape data 
## Extract the ID  
id_vec <- vector("numeric", length = n_pt)
id_vec <- sd_data[1, "id", 1:n_pt]
names(id_vec) <- NULL

## Initialise a 3D array
sd_data_new <- array(0, dim = dim(sd_data))
col_names <- c("id", "s_dec_1", "s_rs_1", "s_rl_1", "s_dl_1", 
							 "so_dec_i", "o_rs_i", "o_rl_i", "o_dl_i", "o_dec_i", 
							 "s_dec_i", "s_rs_i", "s_rl_i", "s_dl_i", 
							 "so_dec_p", "o_rs_p", "o_rl_p", "o_dl_p", "o_dec_p", 
							 "s_dec_p", "s_rs_p", "s_rl_p", "s_dl_p")
colnames(sd_data_new) <- col_names

## Reshape data 
for (i in 1:n_pt) {
	
	other1_pref <- other_k$other1_pref[i]
	
	if (other1_pref == "i") {
		sd_data_new[, 1:5, i] <- sd_data[, 1:5, i] # from id to s_dl_1
		sd_data_new[, 6:14, i] <- sd_data[, 6:14, i] # from so_dec_i to s_dl_i 
		sd_data_new[, 15:23, i] <- sd_data[, 15:23, i] # from so_dec_p to s_dl_p 
	} else if (other1_pref == "p") {
		sd_data_new[, 1:5, i] <- sd_data[, 1:5, i] # from id to s_dl_1 
		sd_data_new[, 6:14, i] <- sd_data[, 15:23, i] # from so_dec_i to s_dl_i 
		sd_data_new[, 15:23, i] <- sd_data[, 6:14, i] # from so_dec_p to s_dl_p 
	}
}

# Calculate accuracy 
## Initialise a tibble to store results 
col_names <- c("id", "acc_i", "acc_p")
acc_mat <- matrix(nrow = n_pt, ncol = length(col_names))
colnames(acc_mat) <- col_names
acc_tb <- as_tibble(acc_mat)
acc_tb$id <- id_vec

rm(acc_mat)

## Initialise arrays 
self_decision <- array(0, dim = c(n_pt, n_trials)) 
reward_sooner <- array(0, dim = c(n_pt, n_trials))
reward_later <- array(0, dim = c(n_pt, n_trials))
delay_later <- array(0, dim = c(n_pt, n_trials))

value_later <- array(0, dim = c(n_pt, n_trials)) # subjective value of later offer
model_choice <- array(0, dim = c(n_pt, n_trials)) 

for (o_block in c("i", "p")) {
	
	other_k_vec <- other_k[, paste0("other_", o_block, "_k")]
	
	for (i_id in 1:n_pt) {
		self_decision[i_id, ] <- sd_data_new[, paste0("so_dec_", o_block), i_id] 
		reward_sooner[i_id, ] <- sd_data_new[, paste0("o_rs_", o_block), i_id]
		reward_later[i_id, ] <- sd_data_new[, paste0("o_rl_", o_block), i_id]
		delay_later[i_id, ] <- sd_data_new[, paste0("o_dl_", o_block), i_id] 
		
		k_value <- as.numeric(10^(other_k_vec[i_id, 1]))
			
		value_later[i_id, ] <- reward_later[i_id, ] / (1 + k_value * delay_later[i_id, ])
		
		model_choice[i_id, ] <- (value_later[i_id, ] > reward_sooner[i_id, ]) + 1
		
		acc <- mean(self_decision[i_id, ] == model_choice[i_id, ])
		acc_tb[i_id, paste0("acc_", o_block)] <- acc
	}
}

# ~~~~ DEMOGRAPHICS ~~~~ ---- 
demogr <- read_csv("data/demographics.csv") |>
	rename(id = ID_Code, group = `Group SD mPFC`, age = Age, gender = Gender) |> 
	dplyr::select(id, group, age, gender) |>
	mutate(id = if_else(id == 2012, 299, id)) |> 
	filter(id < 600) |>
	filter(id %in% incl_id) |>
	arrange(group, id) 

# ~~~~ QUESTIONNAIRES ~~~~ ---- 
qnr <- read_csv("data/questionnaires.csv") |> 
	rename(id = ID_Code, 
				 iq = WTAW_Standard, 
				 trail_a = `Trail_Making_A_(seconds)'`, 
				 trail_b = `Trail_Making_B_(seconds)'`, 
				 ami_total = AMI_tot, 
				 ami_ba = AMI_BA, 
				 ami_sm = AMI_SM, 
				 ami_es = AMI_ES, 
				 bdi_total = BDI_total, 
				 edu = Education_years) |> 
	dplyr::select(id, iq, trail_a, trail_b, ami_total, ami_ba, ami_sm, ami_es, bdi_total, edu,
								SD_similar_p1, SD_similar_p2) |> 
	mutate(id = if_else(id == 2012, 299, id)) |> 
	filter(id < 600) |> 
	filter(id %in% incl_id) |> 
	mutate(iq = as.numeric(iq), 
				 trail_a = replace(trail_a, is.nan(trail_a), NA),
				 trail_b = replace(trail_b, is.nan(trail_b), NA), 
				 ami_total = replace(ami_total, is.nan(ami_total), NA), 
				 ami_ba = replace(ami_ba, is.nan(ami_ba), NA),
				 ami_sm = replace(ami_sm, is.nan(ami_sm), NA),
				 ami_es = replace(ami_es, is.nan(ami_es), NA), 
				 bdi_total = replace(bdi_total, is.nan(bdi_total), NA), 
				 edu = replace(edu, is.nan(edu), NA), 
				 SD_similar_p1 = replace(SD_similar_p1, is.nan(SD_similar_p1), NA),
				 SD_similar_p2 = replace(SD_similar_p2, is.nan(SD_similar_p2), NA),
				 )

# ~~~~ KL DIVERGENCE ~~~~ ----
load("data/ku0_kld_hc.RData")
kld_hc <- result_tb
load("data/ku0_kld_mpfc.RData")
kld_mpfc <- result_tb
load("data/ku0_kld_lc.RData")
kld_lc <- result_tb
rm(result_tb)

## Merge tables 
kld <- rbind(kld_hc, kld_mpfc, kld_lc) |>
	filter(id %in% incl_id) # exclude participants 

rm(kld_hc, kld_mpfc, kld_lc)

# ~~~~ MERGING ~~~~ ---- 
data_all <- demogr |> 
	left_join(qnr, by = "id") |> 
	left_join(acc_tb, by = "id") |> 
	left_join(other_k, by = "id") |> 
	left_join(kld, by = "id") |>
	mutate(group = as.factor(group)) |>
	filter(!id %in% excl_id)
```

```{r}
#| label: preprocessing_2
#| echo: false 
#| warning: false 

# Handle exceptions:
## when subjects had no Others of different preferences. 
# 
# Current measure: 
## Data were analysed for Others with the greatest distance between
## the subjectâ€™s own discount rate, and the Other's discount rate estimated by subject.

n_pt <- dim(data_all)[1]

for (i_id in 1:n_pt) {
	diff_i <- data_all[i_id, "self_1_km"] - data_all[i_id, "other_i_km"]
	diff_p <- data_all[i_id, "self_1_km"] - data_all[i_id, "other_p_km"]
	
	# no Impulsive other
	if (check_sign(diff_i, diff_p) && diff_i > 0) { 
		if (abs(diff_i) > abs(diff_p)) {
			data_all[i_id, "acc_p"] <- data_all[i_id, "acc_i"]
			data_all[i_id, "acc_i"] <- NA
		} else if (abs(diff_i) < abs(diff_p)) {
			data_all[i_id, "acc_i"] <- NA
		}
	}
	
	# no Patient other 
	if (check_sign(diff_i, diff_p) && diff_i < 0) { 
		if (abs(diff_i) > abs(diff_p)) {
			data_all[i_id, "acc_p"] <- NA
		} else if (abs(diff_i) < abs(diff_p)) {
			data_all[i_id, "acc_i"] <- data_all[i_id, "acc_p"]
			data_all[i_id, "acc_p"] <- NA
		}
	}
}

# ~~~~ FACTOR LEVELS ~~~~ ---- 
## For plotting, the order is: HC, mPFC, LC
data_all_plt <- data_all |>
	mutate(group = factor(group, 
												levels = c(1, 3, 4), 
												labels = c("HC", "mPFC", "LC"), 
												ordered = FALSE))

## For modelling, the order is: mPFC, HC, LC
data_all <- data_all |>
	mutate(group = factor(group, 
												levels = c(3, 1, 4), 
												labels = c("mPFC", "HC", "LC"), 
												ordered = FALSE))
```

# 0-5. Save the pre-processed data 

```{r}
#| label: save
#| echo: false 
#| warning: false 

if (is_save == 1) {
	saveRDS(data_all, file = "data/data_all.RData")
	write_csv(data_all, file = "data/data_all.csv")
	
	saveRDS(data_all_plt, file = "data/data_all_plt.RData")
	write_csv(data_all_plt, file = "data/data_all_plt.csv")
}
```

# 1. Demographics (**Table S1**)

```{r}
#| label: demographics 
#| echo: false
#| warning: false 

# Sample size   
demogr_sample_size <- calculate_sample_size(data_all, "id", "group")

# Age 
demogr_age <- get_summary(data_all, "age", "group")

## Linear regression 
lm_model <- lm(age ~ group, data = data_all)
lm_model_stats <- stats_lm(lm_model)
row.names(lm_model_stats) <- c("Intercept", 
															 "Group (HC vs mPFC)", 
															 "Group (LC vs mPFC)")

r_squared <- summary(lm_model)$r.squared
adjusted_r_squared <- summary(lm_model)$adj.r.squared

kable(lm_model_stats, align = rep("c", 6),
			caption = "Linear regression for age") |>
	footnote(general = paste("R <sup>2</sup> / Adjusted R <sup>2</sup>:",
													 pvalr(r_squared, html = TRUE), "/", 
													 pvalr(adjusted_r_squared, html = TRUE)),
					 general_title = "",
           escape = FALSE) |>
	kable_styling()

# Gender
demogr_female <- calculate_females(data_all, "group")
chisq_test(data_all$gender, data_all$group)

## Logistic regression
data_gender <- data_all |>
	dplyr::select(id, group, gender) |> 
	mutate(bi_gender = gender - 1)

logit_model <- glm(bi_gender ~ group, family = binomial(link = "logit"), data = data_gender)
logit_model_stats <- stats_lm(logit_model)
row.names(logit_model_stats) <- c("Intercept",
																	"Group (HC vs mPFC)",
																	"Group (LC vs mPFC)")

kable(logit_model_stats, align = rep("c", 6),
			caption = "Binary logistic regression for gender") |>
	kable_styling()
```

## 1.1. Education years 

```{r}
#| label: education 
#| echo: false 
#| warning: false 

edu_sample_size <- calculate_sample_size(data_all, "edu", "group")
edu_summary <- get_summary(data_all, "edu", "group")
edu_norm <- check_normality(data_all, "edu", "group")

# Linear regression
lm_model <- lm(edu ~ group, data = data_all)
lm_model_stats <- stats_lm(lm_model)
row.names(lm_model_stats) <- c("Intercept", 
															 "Group (HC vs mPFC)", 
															 "Group (LC vs mPFC)")

r_squared <- summary(lm_model)$r.squared
adjusted_r_squared <- summary(lm_model)$adj.r.squared

kable(lm_model_stats, align = rep("c", 6),
			caption = "Linear regression for education years") |>
	footnote(general = paste("R <sup>2</sup> / Adjusted R <sup>2</sup>:",
													 pvalr(r_squared, html = TRUE), "/", 
													 pvalr(adjusted_r_squared, html = TRUE)),
					 general_title = "",
           escape = FALSE) |>
	kable_styling()
```

## 1.2. Apathy-Motivation Index (AMI)

```{r}
#| label: ami 
#| echo: false 
#| warning: false

ami_total_sample_size <- calculate_sample_size(data_all, "ami_total", "group")
ami_total_summary <- get_summary(data_all, "ami_total", "group")
ami_total_norm <- check_normality(data_all, "ami_total", "group")

## Linear regression
lm_model <- lm(ami_total ~ group, data = data_all)
lm_model_stats <- stats_lm(lm_model)
row.names(lm_model_stats) <- c("Intercept", 
															 "Group (HC vs mPFC)", 
															 "Group (LC vs mPFC)")

r_squared <- summary(lm_model)$r.squared
adjusted_r_squared <- summary(lm_model)$adj.r.squared

kable(lm_model_stats, align = rep("c", 6),
			caption = "Linear regression for AMI total") |>
	footnote(general = paste("R <sup>2</sup> / Adjusted R <sup>2</sup>:",
													 pvalr(r_squared, html = TRUE), "/", 
													 pvalr(adjusted_r_squared, html = TRUE)),
					 general_title = "",
           escape = FALSE) |>
	kable_styling()
```

## 1.3. Beck Depression Inventory (BDI)

```{r}
#| label: bdi 
#| echo: false 
#| warning: false

bdi_sample_size <- calculate_sample_size(data_all, "bdi_total", "group")
bdi_summary <- get_summary(data_all, "bdi_total", "group")
bdi_norm <- check_normality(data_all, "bdi_total", "group")

## Linear regression
lm_model <- lm(bdi_total ~ group, data = data_all)
lm_model_stats <- stats_lm(lm_model)
row.names(lm_model_stats) <- c("Intercept", 
															 "Group (HC vs mPFC)", 
															 "Group (LC vs mPFC)")

r_squared <- summary(lm_model)$r.squared
adjusted_r_squared <- summary(lm_model)$adj.r.squared

kable(lm_model_stats, align = rep("c", 6),
			caption = "Linear regression for BDI") |>
	footnote(general = paste("R <sup>2</sup> / Adjusted R <sup>2</sup>:",
													 pvalr(r_squared, html = TRUE), "/", 
													 pvalr(adjusted_r_squared, html = TRUE)),
					 general_title = "",
           escape = FALSE) |>
	kable_styling()
```

## 1.4. Executive function (Trail Making Test)

```{r}
#| label: trail_making
#| echo: false
#| warning: false

# Trail A
trail_a_sample_size <- calculate_sample_size(data_all, "trail_a", "group")
trail_a_summary <- get_summary(data_all, "trail_a", "group")
trail_a_norm <- check_normality(data_all, "trail_a", "group")

## Linear regression 
lm_model <- lm(trail_a ~ group, data = data_all)
lm_model_stats <- stats_lm(lm_model)
row.names(lm_model_stats) <- c("Intercept", 
															 "Group (HC vs mPFC)", 
															 "Group (LC vs mPFC)")

r_squared <- summary(lm_model)$r.squared
adjusted_r_squared <- summary(lm_model)$adj.r.squared

kable(lm_model_stats, align = rep("c", 6),
			caption = "Linear regression for Trail Making Test A") |>
	footnote(general = paste("R <sup>2</sup> / Adjusted R <sup>2</sup>:",
													 pvalr(r_squared, html = TRUE), "/", 
													 pvalr(adjusted_r_squared, html = TRUE)),
					 general_title = "",
           escape = FALSE) |>
	kable_styling()

# Trail B
trail_b_sample_size <- calculate_sample_size(data_all, "trail_b", "group")
trail_b_summary <- get_summary(data_all, "trail_b", "group")
trail_b_norm <- check_normality(data_all, "trail_b", "group")

## Linear regression 
lm_model <- lm(trail_b ~ group, data = data_all)
lm_model_stats <- stats_lm(lm_model)
row.names(lm_model_stats) <- c("Intercept", 
															 "Group (HC vs mPFC)", 
															 "Group (LC vs mPFC)")

r_squared <- summary(lm_model)$r.squared
adjusted_r_squared <- summary(lm_model)$adj.r.squared

kable(lm_model_stats, align = rep("c", 6),
			caption = "Linear regression for Trail Making Test B") |>
	footnote(general = paste("R <sup>2</sup> / Adjusted R <sup>2</sup>:",
													 pvalr(r_squared, html = TRUE), "/", 
													 pvalr(adjusted_r_squared, html = TRUE)),
					 general_title = "",
           escape = FALSE) |>
	kable_styling()
```

## 1.5. Perceived similarity 

```{r}
#| label: similarity 
#| echo: false 
#| warning: false 

# Preparation 
data_similar_1 <- data_all |> 
	dplyr::select(id, group, SD_similar_p1, other1_pref) |>
	rename(sd_similar = SD_similar_p1, 
				 other_pref = other1_pref) |> 
	mutate(condition = interaction(group, other_pref, sep = ":"))

data_similar_2 <- data_all |> 
	dplyr::select(id, group, SD_similar_p2, other2_pref) |> 
	rename(sd_similar = SD_similar_p2, 
				 other_pref = other2_pref) |> 
	mutate(condition = interaction(group, other_pref, sep = ":"))

data_similar <- rbind(data_similar_1, data_similar_2) |>
	arrange(id, other_pref)

rm(data_similar_1, data_similar_2)

# Sum-to-zero coding
contrasts(data_similar$other_pref) <- c(-1, 1)

# LMM2 (in the supplement)
lmer_model <- lmer(sd_similar ~ 1 + group * other_pref + (1|id), 
									 data = data_similar)

similar_lmer_table_full <- model_parameters(lmer_model)

similar_lmer_table <- similar_lmer_table_full |>
	filter(Effects == "fixed") |> 
	dplyr::select(!c(df_error, Effects, Group, CI)) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupmPFC", replacement = "Group (mPFC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupHC", replacement = "Group (HC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupLC", replacement = "Group (LC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "other_pref1", replacement = "Others (patient)"))
	
print(similar_lmer_table)

# Linear regression 
data_similar_mpfc <- data_similar |>
	filter(group == "mPFC")

similar_lm_model_mpfc <- lm(sd_similar ~ other_pref, data = data_similar_mpfc)

result_similar_lm_model_mpfc <- model_parameters(similar_lm_model_mpfc)

# Bayes factor 
data_similar_bayes <- data_similar |>
	mutate(id = as.factor(id)) |> 
	filter(!is.na(sd_similar))

data_similar_bayes_mpfc <- data_similar_bayes |>
	filter(group == "mPFC")

# BF_01 for differences between impulsive and patient others (for mPFC)
set.seed(1213)
bf10_similar_others_mpfc <- ttestBF(data_similar_bayes_mpfc$sd_similar[data_similar_bayes_mpfc$other_pref == "p"], 
															 data_similar_bayes_mpfc$sd_similar[data_similar_bayes_mpfc$other_pref == "i"])

bf01_similar_others_mpfc <- 1 / bf10_similar_others_mpfc
bf01_similar_others_mpfc <- extractBF(bf01_similar_others_mpfc)
```

# 2. Accuracy 
## 2.1. Preparation
```{r}
#| label: accuracy_preparation
#| echo: false
#| warning: false

# Preparation 
data_acc_1 <- data_all |> 
	dplyr::select(id, group, acc_i) |> 
	rename(acc = acc_i) |> 
	mutate(other_pref = "i", 
				 other_pref = as.factor(other_pref)) 

data_acc_2 <- data_all |> 
	dplyr::select(id, group, acc_p) |> 
	rename(acc = acc_p) |> 
	mutate(other_pref = "p", 
				 other_pref = as.factor(other_pref)) 

data_acc <- rbind(data_acc_1, data_acc_2) |>
	mutate(acc = acc * 100) |>
	mutate(other_pref = factor(other_pref, 
														 levels = c("i", "p"), 
														 labels = c("impulsive", "patient"),
														 ordered = FALSE)) |>
	mutate(condition1 = interaction(group, other_pref, sep = ":")) |>
	arrange(id, other_pref)

rm(data_acc_1, data_acc_2)

# Sum-to-zero coding of other's preferences
contrasts(data_acc$other_pref) <- c(-1, 1)

# Preparation for plotting
data_acc_plt_1 <- data_all_plt |> 
	dplyr::select(id, group, acc_i) |> 
	rename(acc = acc_i) |> 
	mutate(other_pref = "i", 
				 other_pref = as.factor(other_pref)) 

data_acc_plt_2 <- data_all_plt |> 
	dplyr::select(id, group, acc_p) |> 
	rename(acc = acc_p) |> 
	mutate(other_pref = "p", 
				 other_pref = as.factor(other_pref)) 

data_acc_plt <- rbind(data_acc_plt_1, data_acc_plt_2) |>
	mutate(acc = acc * 100) |>
	mutate(other_pref = factor(other_pref, 
														 levels = c("i", "p"), 
														 labels = c("impulsive", "patient"),
														 ordered = FALSE)) |>
	mutate(condition1 = interaction(group, other_pref, sep = ":")) |>
	arrange(id, other_pref)

rm(data_acc_plt_1, data_acc_plt_2)
```

## 2.2. Descriptive 

```{r}
#| label: accuracy_descriptive 
#| echo: false 
#| warning: false 

# Summary 
acc_sample_size <- calculate_sample_size(data_acc, "acc", "condition1")
acc_summary <- get_summary(data_acc, "acc", "condition1")

summary_table <- tibble(
	"Accuracy" = c("Impulsive Other", "Patient Other"), 
	"Healthy controls mean (SE)" = c(paste0(specify_decimal(acc_summary[["HC:impulsive"]]$mean, 3), 
															 " (", 
															 specify_decimal(acc_summary[["HC:impulsive"]]$se, 3),
															 ")"),
																paste0(specify_decimal(acc_summary[["HC:patient"]]$mean, 3), 
															 " (", 
															 specify_decimal(acc_summary[["HC:patient"]]$se, 3),
															 ")")), 
	"mPFC lesions mean (SE)" = c(paste0(specify_decimal(acc_summary[["mPFC:impulsive"]]$mean, 3), 
															 " (", 
															 specify_decimal(acc_summary[["mPFC:impulsive"]]$se, 3),
															 ")"),
																paste0(specify_decimal(acc_summary[["mPFC:patient"]]$mean, 3), 
															 " (", 
															 specify_decimal(acc_summary[["mPFC:patient"]]$se, 3),
															 ")")), 
	"Lesion controls mean (SE)" = c(paste0(specify_decimal(acc_summary[["LC:impulsive"]]$mean, 3), 
															 " (", 
															 specify_decimal(acc_summary[["LC:impulsive"]]$se, 3),
															 ")"),
																paste0(specify_decimal(acc_summary[["LC:patient"]]$mean, 3), 
															 " (", 
															 specify_decimal(acc_summary[["LC:patient"]]$se, 3),
															 ")"))
	)

kable(summary_table, 
      align = c("l", "c", "c"), 
      caption = "Summary table of learning accuracy") |> 
	kable_styling()

# Binomial test
## HC - impulsive 
acc_hc_impulsive_all <- data_acc |>
	filter(group == "HC" & other_pref == "impulsive") |> 
	filter(!is.na(acc)) |>
	count() |> 
	pull(n)

acc_hc_impulsive_above50 <- data_acc |>
	filter(group == "HC" & other_pref == "impulsive") |> 
	filter(!is.na(acc)) |>
	filter(acc > 50) |> 
	count() |> 
	pull(n)

acc_ha_impulsive_binom <- binom.test(x = acc_hc_impulsive_above50, 
																		 n = acc_hc_impulsive_all, 
																		 p = 0.5, alternative = "greater")

## mPFC - impulsive
acc_mpfc_impulsive_all <- data_acc |>
	filter(group == "mPFC" & other_pref == "impulsive") |> 
	filter(!is.na(acc)) |>
	count() |> 
	pull(n)

acc_mpfc_impulsive_above50 <- data_acc |>
	filter(group == "mPFC" & other_pref == "impulsive") |> 
	filter(!is.na(acc)) |>
	filter(acc > 50) |> 
	count() |> 
	pull(n)

acc_mpfc_impulsive_binom <- binom.test(x = acc_mpfc_impulsive_above50,
																			 n = acc_mpfc_impulsive_all,
																			 p = 0.5, alternative = "greater")

## LC - impulsive 
acc_lc_impulsive_all <- data_acc |>
	filter(group == "LC" & other_pref == "impulsive") |> 
	filter(!is.na(acc)) |>
	count() |> 
	pull(n)

acc_lc_impulsive_above50 <- data_acc |>
	filter(group == "LC" & other_pref == "impulsive") |> 
	filter(!is.na(acc)) |>
	filter(acc > 50) |> 
	count() |> 
	pull(n)

acc_lc_impulsive_binom <- binom.test(x = acc_lc_impulsive_above50,
																		 n = acc_lc_impulsive_all,
																		 p = 0.5, alternative = "greater")

## HC - patient 
acc_hc_patient_all <- data_acc |>
	filter(group == "HC" & other_pref == "patient") |> 
	filter(!is.na(acc)) |>
	count() |> 
	pull(n)

acc_hc_patient_above50 <- data_acc |>
	filter(group == "HC" & other_pref == "patient") |> 
	filter(!is.na(acc)) |>
	filter(acc > 50) |> 
	count() |> 
	pull(n)

acc_ha_patient_binom <- binom.test(x = acc_hc_patient_above50,
																	 n = acc_hc_patient_all,
																	 p = 0.5, alternative = "greater")

## mPFC - patient
acc_mpfc_patient_all <- data_acc |>
	filter(group == "mPFC" & other_pref == "patient") |> 
	filter(!is.na(acc)) |>
	count() |> 
	pull(n)

acc_mpfc_patient_above50 <- data_acc |>
	filter(group == "mPFC" & other_pref == "patient") |> 
	filter(!is.na(acc)) |>
	filter(acc > 50) |> 
	count() |> 
	pull(n)

acc_mpfc_patient_binom <- binom.test(x = acc_mpfc_patient_above50,
																		 n = acc_mpfc_patient_all,
																		 p = 0.5, alternative = "greater")

## LC - patient  
acc_lc_patient_all <- data_acc |>
	filter(group == "LC" & other_pref == "patient") |> 
	filter(!is.na(acc)) |>
	count() |> 
	pull(n)

acc_lc_patient_above50 <- data_acc |>
	filter(group == "LC" & other_pref == "patient") |> 
	filter(!is.na(acc)) |>
	filter(acc > 50) |> 
	count() |> 
	pull(n)

acc_lc_patient_binom <- binom.test(x = acc_lc_patient_above50,
																	 n = acc_lc_patient_all,
																	 p = 0.5, alternative = "greater")
```

## 2.3. Linear mixed-effects models LMM1a-1c (**Table S2**)

```{r}
#| label: accuracy_lmm 
#| echo: false 
#| warning: false 

# LMM1a 
lmer_model <- lmer(acc ~ 1 + group * other_pref + (1|id), data = data_acc)

acc_lmer_table_full <- model_parameters(lmer_model)

acc_lmer_table <- acc_lmer_table_full |>
	filter(Effects == "fixed") |> 
	dplyr::select(!c(df_error, Effects, Group, CI)) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupHC", replacement = "Group (HC vs mPFC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupLC", replacement = "Group (LC vs mPFC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "other_pref1", replacement = "Others (patient vs impulsive)"))
	
print(acc_lmer_table)

## Post-hoc comparisons 
post_hoc_acc <- contrast(emmeans(lmer_model, ~ group), "pairwise", adjust = NULL)

print(post_hoc_acc)

# LMM1b (control for depression)
data_bdi <- data_all |>
	dplyr::select(id, group, bdi_total) |>
	mutate(id = as.factor(id))

data_acc <- data_acc |>
	mutate(id = as.factor(id))

data_acc_bdi <- data_acc |>
	left_join(data_bdi, by = c("id", "group"))

lmer_model_bdi <- lmer(acc ~ 1 + group * other_pref + bdi_total + (1|id), data = data_acc_bdi)

acc_lmer_table_full_bdi <- model_parameters(lmer_model_bdi)

acc_lmer_table_bdi <- acc_lmer_table_full_bdi |>
	filter(Effects == "fixed") |> 
	dplyr::select(!c(df_error, Effects, Group, CI)) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupHC", replacement = "Group (HC vs mPFC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupLC", replacement = "Group (LC vs mPFC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "other_pref1", replacement = "Others (patient vs impulsive)")) |> 
	mutate(Parameter = str_replace(Parameter, pattern = "bdi_total", replacement = "BDI"))

print(acc_lmer_table_bdi)

# LMM1c (control for apathy)
data_ami <- data_all |>
	dplyr::select(id, group, ami_total) |>
	mutate(id = as.factor(id))

data_acc_ami <- data_acc |>
	left_join(data_ami, by = c("id", "group"))

lmer_model_ami <- lmer(acc ~ 1 + group * other_pref + ami_total + (1|id), data = data_acc_ami)

acc_lmer_table_full_ami <- model_parameters(lmer_model_ami)

acc_lmer_table_ami <- acc_lmer_table_full_ami |>
	filter(Effects == "fixed") |> 
	dplyr::select(!c(df_error, Effects, Group, CI)) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupHC", replacement = "Group (HC vs mPFC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupLC", replacement = "Group (LC vs mPFC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "other_pref1", replacement = "Others (patient vs impulsive)")) |> 
	mutate(Parameter = str_replace(Parameter, pattern = "ami_total", replacement = "AMI"))

print(acc_lmer_table_ami)
```

## 2.4 Bayes factor 

```{r}
#| label: accuracy_bayes 
#| echo: false 
#| warning: false 

data_acc_bayes <- data_acc |>
	mutate(id = as.factor(id)) |> 
	filter(!is.na(acc))

data_acc_overall_bayes <- data_acc_bayes |> 
	group_by(id, group) |> 
	summarise(mean_acc = mean(acc), .groups = "drop")

# BF_01 for differences between mPFC and LC
set.seed(1213)

bf10_acc_mpfc_lc_overall <- ttestBF(data_acc_overall_bayes$mean_acc[data_acc_overall_bayes$group == "mPFC"], 
																		data_acc_overall_bayes$mean_acc[data_acc_overall_bayes$group == "LC"])

bf01_acc_mpfc_lc_overall <- 1 / bf10_acc_mpfc_lc_overall
bf01_acc_mpfc_lc_overall <- extractBF(bf01_acc_mpfc_lc_overall)
```

## 2.4. Plot (**Figure 2c**)

```{r}
#| label: fig-accuracy
#| echo: false 
#| warning: false 
#| fig-cap: "Learning performances." 
#| fig-width: 4.25
#| fig-height: 5

# Preparation 
vars <- "acc"

plt_data <- data_acc_plt |> 
	group_by(group, other_pref, condition1) |> 
	filter(!is.na(get(vars))) |>
	summarise(n = n(), 
						mean = mean(get(vars), na.rm = TRUE), 
						sd = sd(get(vars), na.rm = TRUE), 
						se = sd / sqrt(n)) |> 
	ungroup()

# ggplot for manuscript
set.seed(1213)
plt <- ggplot(plt_data, aes(x = group, y = mean, group = condition1)) +
	geom_jitter(data = data_acc_plt,
							aes(x = group, y = get(vars), 
									colour = other_pref, 
									alpha = other_pref), 
							position = position_jitterdodge(dodge.width = 0.75, 
																							jitter.height = 0, 
																							jitter.width = 0.3), 
							size = 1, stroke = 0.5,
							show.legend = FALSE) + 
	geom_errorbar(aes(ymin = mean - se, 
										ymax = mean + se), 
								position = position_dodge(0.75), 
								colour = "black", width = 0, size = 0.25) + 
	geom_jitter(aes(y = mean, 
									fill = other_pref), 
							position = position_dodge(0.75), 
							colour = "black", shape = 21, stroke = 0.25, size = 2) + 
	scale_x_discrete(labels = c("Healthy\ncontrols", 
															"mPFC\nlesions", 
															"Lesion\ncontrols")) +
	coord_cartesian(ylim = c(50, 105), expand = FALSE) +  
	labs(x = NULL, y = "Learning accuracy (%)") +
	scale_fill_manual(name = "other_pref", 
										limits = c("impulsive", "patient"), 
										values = c("#5491cb", "#fcd466"), 
										labels = c("Impulsive", "Patient")) +
	scale_colour_manual(name = "other_pref",
											limits = c("impulsive", "patient"),
											values = c("#abdeff", "#ffeacb")) +
	scale_alpha_manual(name = "other_pref",
											limits = c("impulsive", "patient"),
											values = c(0.4, 0.4)) + 
	theme_classic() +
	theme(text = element_text(family = "Arial"),
				legend.title = element_blank(),
				legend.key = element_rect(linewidth = c(2, 2), colour = NA),
				axis.text.x = element_text(size = 10),
				axis.text.y = element_markdown(size = 10), 
				axis.title.x = element_markdown(size = 10), 
				axis.title.y = element_markdown(size = 12, lineheight = 1.2), 
				legend.text = element_text(size = 8, margin = margin(l = 0)),
				legend.key.height = unit(0.3, "cm"),
				legend.key.width = unit(0.3, "cm"),
				legend.key.spacing.y = unit(0.1, "cm"), 
				legend.justification = c(0, 0.5)) +
	geom_signif(xmin = 1, xmax = 2,
							y_position = 96.5, tip_length = 0.01, vjust = 0.5, size = 0.25,
							textsize = 3, family = "Arial",
							annotation = "**") + 
	geom_signif(xmin = 1, xmax = 3,
							y_position = 92.5, tip_length = 0.01, vjust = 0.5, size = 0.25,
							textsize = 3, family = "Arial",
							annotation = "**")

print(plt) 

if (is_save == 1) {
	ggsave("data/plots/acc.png", plt,
				 height = plot_h, width = plot_h * 0.85, dpi = resolution)
}
```

# 3. Mean of discounting distribution (*km*)
## 3.1. Preparation 

```{r}
#| label: km 
#| echo: false 
#| warning: false 

data_km <- data_all |> 
	dplyr::select(id, group, self_1_km)

data_km_plt <- data_all_plt |>
	dplyr::select(id, group, self_1_km)
```

## 3.2. Descriptive 

```{r}
#| label: km_descriptive 
#| echo: false 
#| warning: false 

# Summary 
km_sample_size <- calculate_sample_size(data_km, "self_1_km", "group")
km_summary <- get_summary(data_km, "self_1_km", "group")

summary_table <- tibble(
	"Accuracy" = c("Self baseline km"), 
	"Healthy controls mean (SE)" = c(paste0(specify_decimal(km_summary[["HC"]]$mean, 3), 
															 " (", 
															 specify_decimal(km_summary[["HC"]]$se, 3),
															 ")")), 
	"mPFC lesions mean (SE)" = c(paste0(specify_decimal(km_summary[["mPFC"]]$mean, 3), 
															 " (", 
															 specify_decimal(km_summary[["mPFC"]]$se, 3),
															 ")")), 
	"Lesion controls mean (SE)" = c(paste0(specify_decimal(km_summary[["LC"]]$mean, 3), 
															 " (", 
															 specify_decimal(km_summary[["LC"]]$se, 3),
															 ")"))
	)

kable(summary_table, 
      align = c("l", "c"), 
      caption = "Summary table of self baseline km") |> 
	kable_styling()

# ANOVA1
km_lm_model <- lm(self_1_km ~ group, data = data_km)
km_anova <- anova(km_lm_model)
print(km_anova)

## Effect size 
options(es.use_symbols = TRUE) # get nice symbols when printing 
km_lm_model_eta <- eta_squared(km_lm_model)

ci.etasqr(0.05, 0.10, 2, 118)

## Post-hoc comparisons
emmeans(km_lm_model, pairwise ~ group, adjust = "none")

# ANOVA2 (control for depression)
data_km_bdi <- data_km |>
	mutate(id = as.factor(id)) |>
	left_join(data_bdi, by = c("id", "group"))

km_lm_model_bdi <- lm(self_1_km ~ bdi_total + group, data = data_km_bdi)

km_anova_bdi <- anova(km_lm_model_bdi)
print(km_anova_bdi)

km_anova_bdi_eta <- eta_squared(km_lm_model_bdi)
ci.etasqr(0.05, 0.09, 2, 115) # group
ci.etasqr(0.05, 0.004, 1, 115) # bdi

# ANOVA3 (control for apathy)
data_km_ami <- data_km |>
	mutate(id = as.factor(id)) |>
	left_join(data_ami, by = c("id", "group"))

km_lm_model_ami <- lm(self_1_km ~ ami_total + group, data = data_km_ami)

km_anova_ami <- anova(km_lm_model_ami)
print(km_anova_ami)

km_anova_ami_eta <- eta_squared(km_lm_model_ami)
ci.etasqr(0.05, 0.08, 2, 115) # group
ci.etasqr(0.05, 0.02, 1, 115) # ami 
```

## 3.3. Bayes factor

```{r}
#| label: km_bayes 
#| echo: false 
#| warning: false 

data_km_bayes <- data_km |>
	mutate(id = as.factor(id)) |> 
	filter(!is.na(self_1_km))

# BF_01 for differences between mPFC and LC
set.seed(1213)
bf10_km_mpfc_lc_overall <- ttestBF(data_km_bayes$self_1_km[data_km_bayes$group == "mPFC"], 
																	 data_km_bayes$self_1_km[data_km_bayes$group == "LC"])

bf01_km_mpfc_lc_overall <- 1 / bf10_km_mpfc_lc_overall
bf01_km_mpfc_lc_overall <- extractBF(bf01_km_mpfc_lc_overall)
```

## 3.4. Plot (**Figure 3b** left)

```{r}
#| label: fig-km
#| echo: false 
#| warning: false 
#| fig-cap: "Mean of discounting distribution." 
#| fig-width: 3
#| fig-height: 5

# Preparation
vars <- "self_1_km"

plt_data <- data_km_plt |> 
	group_by(group) |> 
	filter(!is.na(get(vars))) |>
	summarise(n = n(), 
						mean = mean(get(vars), na.rm = TRUE), 
						sd = sd(get(vars), na.rm = FALSE), 
						se = sd / sqrt(n)) |> 
	ungroup() 

# ggplot for manuscript
set.seed(1213)
plt <- ggplot(plt_data, aes(x = group , y = mean)) + 
	geom_bar(aes(y = mean),
					 fill = "#00a087", 
					 stat = "identity",
					 width = 0.5, linewidth = 0.3,
					 colour = "black") +
	geom_jitter(data = data_km_plt,
							aes(x = group, y = get(vars)),
							colour = "#b8eddf",
							alpha = 0.6, 
							position = position_jitter(height = 0,
																				 width = 0.15), 
							size = 1.3, stroke = 0.5,
							show.legend = FALSE) +
	geom_errorbar(aes(ymin = mean - se, 
										ymax = mean + se), 
								colour = "black", width = 0, size = 0.25) +
	scale_x_discrete(labels = c("Healthy\ncontrols", 
															"mPFC\nlesions", 
															"Lesion\ncontrols")) +
	scale_y_continuous(limits = c(-12.5, 0.5), 
										 breaks = c(-12, -10, -8, -6, -4, -2, 0), 
										 expan = expansion(mult = c(0, 0))) + 
	labs(x = NULL, y = "Mean of baseline discount distribution") +
	theme_classic() + 
	theme(text = element_text(family = "Arial"),
				legend.title = element_blank(),
				legend.key = element_rect(linewidth = c(2, 2), colour = NA),
				axis.text.x = element_text(size = 10),
				axis.text.y = element_text(size = 10), 
				axis.title.x = element_text(size = 10), 
				axis.title.y = element_markdown(size = 12, lineheight = 1.2), 
				legend.position = "none") +
	geom_hline(yintercept = 0, linetype = "dashed") + 
	geom_signif(xmin = 1, xmax = 2,
							y_position = -5.5, tip_length = 0, vjust = 1.75, size = 0.25,
							textsize = 3.5, family = "Arial",
							annotation = "**")+
	geom_signif(xmin = 1, xmax = 3, 
							y_position = -6, tip_length = 0, vjust = 1.75, size = 0.25,
							textsize = 3.5, family = "Arial",
							annotation = "*") 
		
print(plt)

if (is_save == 1) {
	ggsave("data/plots/km.png", plt,
				 height = plot_h, width = plot_h * 0.6, dpi = resolution)
}
```

# 4. Standard deviation of discounting distribution (*ku*)
## 4.1. Preparation 

```{r}
#| label: ku
#| echo: false 
#| warning: false 

# Preparation
data_ku <- data_all |> 
	dplyr::select(id, group, self_1_ku)

data_ku_plt <- data_all_plt |>
	dplyr::select(id, group, self_1_ku)
```

## 4.2. Descriptive 

```{r}
#| label: ku_descriptive 
#| echo: false 
#| warning: false 

# Summary 
ku_sample_size <- calculate_sample_size(data_ku, "self_1_ku", "group")
ku_summary <- get_summary(data_ku, "self_1_ku", "group")

summary_table <- tibble(
	"Accuracy" = c("Self baseline ku"), 
	"Healthy controls mean (SE)" = c(paste0(specify_decimal(ku_summary[["HC"]]$mean, 3), 
															 " (", 
															 specify_decimal(ku_summary[["HC"]]$se, 3),
															 ")")), 
	"mPFC lesions mean (SE)" = c(paste0(specify_decimal(ku_summary[["mPFC"]]$mean, 3), 
															 " (", 
															 specify_decimal(ku_summary[["mPFC"]]$se, 3),
															 ")")), 
	"Lesion controls mean (SE)" = c(paste0(specify_decimal(ku_summary[["LC"]]$mean, 3), 
															 " (", 
															 specify_decimal(ku_summary[["LC"]]$se, 3),
															 ")"))
	)

kable(summary_table, 
      align = c("l", "c"), 
      caption = "Summary table of self baseline ku") |> 
	kable_styling()

# ANOVA1
ku_lm_model <- lm(self_1_ku ~ group, data = data_ku)
ku_anova <- anova(ku_lm_model)
print(ku_anova)

## Effect size 
options(es.use_symbols = TRUE) # get nice symbols when printing 
ku_lm_model_eta <- eta_squared(ku_lm_model)

ci.etasqr(0.05, 0.14, 2, 118)

## Post-hoc comparisons
emmeans(ku_lm_model, pairwise ~ group, adjust = "none")

# ANOVA2 (control for depression)
data_ku_bdi <- data_ku |>
	mutate(id = as.factor(id)) |>
	left_join(data_bdi, by = c("id", "group"))

ku_lm_model_bdi <- lm(self_1_ku ~ bdi_total + group, data = data_ku_bdi)

ku_anova_bdi <- anova(ku_lm_model_bdi)
print(ku_anova_bdi)

ku_anova_bdi_eta <- eta_squared(ku_lm_model_bdi)
ci.etasqr(0.05, 0.11, 2, 115) # group
ci.etasqr(0.05, 0.08, 1, 115) # bdi 

# ANOVA3 (control for apathy)
data_ku_ami <- data_ku |>
	mutate(id = as.factor(id)) |>
	left_join(data_ami, by = c("id", "group"))

ku_lm_model_ami <- lm(self_1_ku ~ ami_total + group, data = data_ku_ami)

ku_anova_ami <- anova(ku_lm_model_ami)
print(ku_anova_ami)

ku_anova_ami_eta <- eta_squared(ku_lm_model_ami)
ci.etasqr(0.05, 0.14, 2, 115) # group 
ci.etasqr(0.05, 0.03, 1, 115) # ami
```
## 4.3. Bayes factor 

```{r}
#| label: ku_bayes 
#| echo: false 
#| warning: false 

data_ku_bayes <- data_ku |>
	mutate(id = as.factor(id)) |> 
	filter(!is.na(self_1_ku))

# BF_01 for differences between mPFC and HC
set.seed(1213)
bf10_ku_mpfc_hc_overall <- ttestBF(data_ku_bayes$self_1_ku[data_ku_bayes$group == "mPFC"], 
																	 data_ku_bayes$self_1_ku[data_ku_bayes$group == "HC"])

bf01_ku_mpfc_hc_overall <- 1 / bf10_ku_mpfc_hc_overall
bf01_ku_mpfc_hc_overall <- extractBF(bf01_ku_mpfc_hc_overall)
```

## 4.4. Plot (**Figure 3b** right)

```{r}
#| label: fig-ku
#| echo: false 
#| warning: false 
#| fig-cap: "Standard deviation of discounting distribution." 
#| fig-width: 3
#| fig-height: 5

# Preparation
vars <- "self_1_ku"

plt_data <- data_ku_plt |> 
	group_by(group) |> 
	filter(!is.na(get(vars))) |>
	summarise(n = n(), 
						mean = mean(get(vars), na.rm = TRUE), 
						sd = sd(get(vars), na.rm = FALSE), 
						se = sd / sqrt(n)) |> 
	ungroup() 

# ggplot for manuscript  
set.seed(1213)
plt <- ggplot(plt_data, aes(x = group , y = mean)) + 
	geom_bar(aes(y = mean),
					 fill = "#00a087", 
					 stat = "identity",
					 width = 0.5, linewidth = 0.3,
					 colour = "black") +
	geom_jitter(data = data_ku_plt,
							aes(x = group, y = get(vars)),
							colour = "#b8eddf",
							alpha = 0.6, 
							position = position_jitter(height = 0,
																				 width = 0.15), 
							size = 1.3, stroke = 0.5,
							show.legend = FALSE) +
	geom_errorbar(aes(ymin = mean - se, 
										ymax = mean + se), 
								colour = "black", width = 0, size = 0.25) +
	scale_x_discrete(labels = c("Healthy\ncontrols", 
															"mPFC\nlesions", 
															"Lesion\ncontrols")) +
	scale_y_continuous(limits = c(-0.5, 4.5), 
										 breaks = c(0, 2, 4), 
										 expan = expansion(mult = c(0, 0))) + 
	labs(x = NULL, y = "SD of baseline discount distribution") +
	theme_classic() + 
	theme(text = element_text(family = "Arial"),
				legend.title = element_blank(),
				legend.key = element_rect(linewidth = c(2, 2), colour = NA),
				axis.text.x = element_text(size = 10),
				axis.text.y = element_text(size = 10), 
				axis.title.x = element_text(size = 10), 
				axis.title.y = element_markdown(size = 12, lineheight = 1.2), 
				legend.position = "none") +
	geom_hline(yintercept = 0, linetype = "dashed") + 
	geom_signif(xmin = 1, xmax = 3,
							y_position = 2.5, tip_length = 0, vjust = 0.5, size = 0.25,
							textsize = 3.5, family = "Arial",
							annotation = "***")+
	geom_signif(xmin = 2, xmax = 3, 
							y_position = 2.75, tip_length = 0, vjust = 0.5, size = 0.25,
							textsize = 3.5, family = "Arial",
							annotation = "**")

print(plt)

if (is_save == 1) {
	ggsave("data/plots/ku.png", plt,
				 height = plot_h, width = plot_h * 0.6, dpi = resolution)
}
```

# 5. Signed KL divergence (D<sub>KL</sub>)
## 5.1. Preparation 

```{r}
#| label: kld 
#| echo: false 
#| warning: false 

# Preparation for modelling
data_kld_i <- data_all |> 
	dplyr::select(id, group, self_1_km, self_1_ku, norm_kl_i) |> 
	mutate(other_pref = "i") |> 
	dplyr::rename(norm_kl = norm_kl_i)

data_kld_p <- data_all |> 
	dplyr::select(id, group, self_1_km, self_1_ku, norm_kl_p) |> 
	mutate(other_pref = "p") |> 
	dplyr::rename(norm_kl = norm_kl_p)

data_kld <- bind_rows(data_kld_i, data_kld_p) |> 
	arrange(group, id, other_pref) |> 
	mutate(other_pref = factor(other_pref, 
														 levels = c("i", "p"), 
														 labels = c("impulsive", "patient"),
														 ordered = FALSE)) |> 
	mutate(condition1 = interaction(group, other_pref, sep = ":"))

rm(data_kld_i, data_kld_p)

# Centring the baseline km
self_1_km_grand_mean <- data_kld |> 
	summarise(mean = mean(self_1_km)) |> 
	as.numeric() 

data_kld <- data_kld |>
	mutate(centred_self_1_km = self_1_km - self_1_km_grand_mean)

# Centring the baseline ku
self_1_ku_grand_mean <- data_kld |> 
	summarise(mean = mean(self_1_ku)) |> 
	as.numeric() 

data_kld <- data_kld |>
	mutate(centred_self_1_ku = self_1_ku - self_1_ku_grand_mean)

# Sum-to-zero coding
contrasts(data_kld$other_pref) <- c(-1, 1) 

# Preparation for plotting
data_kld_plt_i <- data_all_plt |> 
	dplyr::select(id, group, self_1_km, self_1_ku, norm_kl_i) |> 
	mutate(other_pref = "i") |> 
	dplyr::rename(norm_kl = norm_kl_i)

data_kld_plt_p <- data_all_plt |> 
	dplyr::select(id, group, self_1_km, self_1_ku, norm_kl_p) |> 
	mutate(other_pref = "p") |> 
	dplyr::rename(norm_kl = norm_kl_p)

data_kld_plt <- bind_rows(data_kld_plt_i, data_kld_plt_p) |> 
	arrange(group, id, other_pref) |> 
	mutate(other_pref = factor(other_pref, 
														 levels = c("i", "p"), 
														 labels = c("impulsive", "patient"),
														 ordered = FALSE)) |> 
	mutate(condition1 = interaction(group, other_pref, sep = ":"))

rm(data_kld_plt_i, data_kld_plt_p)
```

## 5.2. Descriptive 

```{r}
#| label: kld_descriptive 
#| echo: false 
#| warning: false 

# Summary
kld_sample_size <- calculate_sample_size(data_kld, "norm_kl", "condition1")
kld_summary <- get_summary(data_kld, "norm_kl", "condition1")

summary_table <- tibble(
	"Signed KL divergence" = c("Impulsive Other", "Patient Other"), 
	"Healthy controls mean (SE)" = c(paste0(specify_decimal(kld_summary[["HC:impulsive"]]$mean, 3), 
															 " (", 
															 specify_decimal(kld_summary[["HC:impulsive"]]$se, 3),
															 ")"),
																paste0(specify_decimal(kld_summary[["HC:patient"]]$mean, 3), 
															 " (", 
															 specify_decimal(kld_summary[["HC:patient"]]$se, 3),
															 ")")), 
	"mPFC lesions mean (SE)" = c(paste0(specify_decimal(kld_summary[["mPFC:impulsive"]]$mean, 3), 
															 " (", 
															 specify_decimal(kld_summary[["mPFC:impulsive"]]$se, 3),
															 ")"),
																paste0(specify_decimal(kld_summary[["mPFC:patient"]]$mean, 3), 
															 " (", 
															 specify_decimal(kld_summary[["mPFC:patient"]]$se, 3),
															 ")")), 
	"Lesion controls mean (SE)" = c(paste0(specify_decimal(kld_summary[["LC:impulsive"]]$mean, 3), 
															 " (", 
															 specify_decimal(kld_summary[["LC:impulsive"]]$se, 3),
															 ")"),
																paste0(specify_decimal(kld_summary[["LC:patient"]]$mean, 3), 
															 " (", 
															 specify_decimal(kld_summary[["LC:patient"]]$se, 3),
															 ")"))
	)

kable(summary_table, 
      align = c("l", "c", "c"), 
      caption = "Summary table of signed KL divergence") |> 
	kable_styling()
```

## 5.3. Linear mixed-effects models LMM3a-3e (**Tables S3-S4**)

### LMM3a (**Table S3**)

```r
lmer_model_3a <- lmer(norm_kl ~ 1 + group * other_pref * centred_self_1_km + (1|id), 
                      data = data_kld)
```

```{r}
#| label: kld_lmm3a
#| echo: false 
#| warning: false 

# LMM3a (Table S3) ---- 
lmer_model_3a <- lmer(norm_kl ~ 1 + group * other_pref * centred_self_1_km + (1|id),
											data = data_kld)

kld_lmer_3a_table_full <- model_parameters(lmer_model_3a)

kld_lmer_3a_table <- kld_lmer_3a_table_full |>
	filter(Effects == "fixed") |>
	dplyr::select(!c(df_error, Effects, Group, CI)) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupHC", replacement = "Group (HC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupmPFC", replacement = "Group (mPFC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupLC", replacement = "Group (LC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "other_pref1", replacement = "Others (patient)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "centred_self_1_km", replacement = "Self baseline km"))

print(kld_lmer_3a_table)

# Post-hoc comparisons
post_kld_3a <- contrast(emmeans(lmer_model_3a, ~ group | other_pref),
												"pairwise", adjust = NULL)

print(post_kld_3a)

## Bayes factor 
data_kld_bayes <- data_kld %>%
	mutate(id = as.factor(id)) %>% 
	filter(!is.na(norm_kl))

data_kld_bayes_patient <- data_kld_bayes %>%
	filter(other_pref == "patient")

# BF_01 for differences between mPFC and HC (patient)
set.seed(1213)
bf10_kld_mpfc_hc_patient <- ttestBF(data_kld_bayes_patient$norm_kl[data_kld_bayes_patient$group == "mPFC"], 
																		data_kld_bayes_patient$norm_kl[data_kld_bayes_patient$group == "HC"])

bf01_kld_mpfc_hc_patient <- 1 / bf10_kld_mpfc_hc_patient
bf01_kld_mpfc_hc_patient <- extractBF(bf01_kld_mpfc_hc_patient)
```

### LMM3b (**Table S3**) control for depression

```r
lmer_model_3b <- lmer(norm_kl ~ 1 + group * other_pref * centred_self_1_km + bdi_total + (1|id),
                      data = data_kld_bdi)
```

```{r}
#| label: kld_lmm3b
#| echo: false 
#| warning: false 

# LMM3b (control for depression; Table S3) ---- 
data_kld_bdi <- data_kld |>
	mutate(id = as.factor(id)) |>
	left_join(data_bdi, by = c("id", "group"))

lmer_model_3b <- lmer(norm_kl ~ 1 + group * other_pref * centred_self_1_km + bdi_total + (1|id), 
											data = data_kld_bdi)

kld_lmer_3b_table_full <- model_parameters(lmer_model_3b)

kld_lmer_3b_table <- kld_lmer_3b_table_full |>
	filter(Effects == "fixed") |>
	dplyr::select(!c(df_error, Effects, Group, CI)) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupHC", replacement = "Group (HC)")) |> 
	mutate(Parameter = str_replace(Parameter, pattern = "groupmPFC", replacement = "Group (mPFC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupLC", replacement = "Group (LC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "other_pref1", replacement = "Others (patient)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "centred_self_1_km", replacement = "Self baseline km")) |> 
	mutate(Parameter = str_replace(Parameter, pattern = "bdi_total", replacement = "BDI"))

print(kld_lmer_3b_table)
```

### LMM3c (**Table S3**) control for apathy

```r
lmer_model_3c <- lmer(norm_kl ~ 1 + ami_total + group * other_pref * centred_self_1_km + (1|id),
                      data = data_kld_ami)
```

```{r}
#| label: kld_lmm3c
#| echo: false 
#| warning: false 

# LMM3c (control for apathy; Table S3) ---- 
data_kld_ami <- data_kld |>
	mutate(id = as.factor(id)) |>
	left_join(data_ami, by = c("id", "group"))

lmer_model_3c <- lmer(norm_kl ~ 1 + ami_total + group * other_pref * centred_self_1_km + (1|id), 
											data = data_kld_ami)

kld_lmer_3c_table_full <- model_parameters(lmer_model_3c)

kld_lmer_3c_table <- kld_lmer_3c_table_full |>
	filter(Effects == "fixed") |>
	dplyr::select(!c(df_error, Effects, Group, CI)) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupHC", replacement = "Group (HC)")) |> 
	mutate(Parameter = str_replace(Parameter, pattern = "groupmPFC", replacement = "Group (mPFC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupLC", replacement = "Group (LC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "other_pref1", replacement = "Others (patient)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "centred_self_1_km", replacement = "Self baseline km")) |> 
	mutate(Parameter = str_replace(Parameter, pattern = "ami_total", replacement = "AMI"))

print(kld_lmer_3c_table)
```

### LMM3d (**Table S4**) control for order 

```r
lmer_model_3d <- lmer(norm_kl ~ 1 + group * other_pref * centred_self_1_km + other1_pref + (1|id),
                      data = data_kld_with_order)
```

```{r}
#| label: kld_lmm3d
#| echo: false 
#| warning: false 

# LMM3d (control for order; Table S4) ---- 
other_order <- data_all |>
	dplyr::select(id, group, other1_pref) |>
	mutate(id = as.factor(id))

data_kld_with_order <- data_kld |>
	mutate(id = as.factor(id)) |>
	left_join(other_order, by = c("id", "group"))

lmer_model_3d <- lmer(norm_kl ~ 1 + group * other_pref * centred_self_1_km + other1_pref + (1|id), 
											data = data_kld_with_order)

kld_lmer_3d_table_full <- model_parameters(lmer_model_3d)

kld_lmer_3d_table <- kld_lmer_3d_table_full |>
	filter(Effects == "fixed") |>
	dplyr::select(!c(df_error, Effects, Group, CI)) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupHC", replacement = "Group (HC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupmPFC", replacement = "Group (mPFC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupLC", replacement = "Group (LC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "other_pref1", replacement = "Others (patient)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "centred_self_1_km", replacement = "Self baseline km")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "other1_prefp", replacement = "Order of others' preferences"))

print(kld_lmer_3d_table)
```

### LMM3e (**Table SX**) control for self baseline preference uncertainty

```r
lmer_model_3e <- lmer(norm_kl ~ 1 + group * other_pref * centred_self_1_km + centred_self_1_ku + (1|id),
                      data = data_kld)
```

```{r}
#| label: kld_lmm3e
#| echo: false 
#| warning: false 

# LMM3e (control for self baseline preference uncertainty; Table SX) ---- 
lmer_model_3e <- lmer(norm_kl ~ 1 + group * other_pref * centred_self_1_km + centred_self_1_ku + (1|id),
											data = data_kld)

kld_lmer_3e_table_full <- model_parameters(lmer_model_3e)

kld_lmer_3e_table <- kld_lmer_3e_table_full |>
	filter(Effects == "fixed") |>
	dplyr::select(!c(df_error, Effects, Group, CI)) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupHC", replacement = "Group (HC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupmPFC", replacement = "Group (mPFC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "groupLC", replacement = "Group (LC)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "other_pref1", replacement = "Others (patient)")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "centred_self_1_km", replacement = "Self baseline km")) |>
	mutate(Parameter = str_replace(Parameter, pattern = "centred_self_1_ku", replacement = "Self baseline ku"))

print(kld_lmer_3e_table)
```

## 5.4. Plot (**Figure 4**)

```{r}
#| label: fig-kld
#| echo: false 
#| warning: false 
#| fig-cap: "Signed KL divergence." 
#| fig-width: 5
#| fig-height: 5

# Preparation 
vars <- "norm_kl"

plt_data <- data_kld_plt |> 
	group_by(group, other_pref, condition1) |>  
	filter(!is.na(get(vars))) |> 
	summarise(n = n(), 
						mean = mean(get(vars), na.rm = TRUE), 
						median = median(get(vars), na.rm = TRUE), 
						sd = sd(get(vars), na.rm = TRUE), 
						se = sd / sqrt(n)) |> 
	ungroup() 

data_kld_plt <- data_kld_plt |> 
	mutate(id = factor(id)) |> 
	mutate(condition2 = interaction(other_pref, group, sep = ":"))

# Plot setting 
pos_dodge <- position_dodge(width = 0.55)

other_lims <- c("impulsive", "patient")
other_labs <- c(" Impulsive other", " Patient other")
other_fills <- c("#5491cb", "#fcd466")
other_cols <- c("#abdeff", "#fde69f")

inter_lims2 <- c("impulsive:HC","patient:HC",
								 "impulsive:mPFC", "patient:mPFC",
								 "impulsive:LC", "patient:LC")

inter_labs2 <- c("", "Healthy\ncontrols", 
								 "", "mPFC\nlesions", 
								 "", "Lesion\ncontrols")

# ggplot for manuscript
plt <- ggplot(data_kld_plt, aes(x = condition2, y = norm_kl, fill = other_pref, 
															  colour = other_pref)) + 
	stat_summary(fun = mean, geom = "bar", 
							 position = position_dodge(0.75), 
							 width = 0.75, alpha = 1, colour = "black", linewidth = 0.3) +
	geom_line(aes(group = id), position = pos_dodge, 
						colour = "grey", alpha = 0.3, linewidth = 0.3) +
	geom_point(aes(group = id), position = pos_dodge, size = 1.5, alpha = 0.5, 
						 show.legend = FALSE) + 
	stat_summary(fun = mean, geom = "bar", 
							 position = position_dodge(0.75), 
							 width = 0.75, alpha = 0, colour = "black", linewidth = 0.3) + 
	stat_summary(fun.data = mean_se, geom = "errorbar", 
							 conf.int = 0.95, position = position_dodge(0.75), 
							 width = 0, colour = "black", alpha = 1, linewidth = 0.3) +
	scale_x_discrete(name = "", limits = inter_lims2, labels = inter_labs2) +
	scale_y_continuous(name = "Signed KL divergence") + 
	scale_fill_manual(limits = other_lims, values = other_fills, 
										labels = other_labs) +
	scale_colour_manual(limits = other_lims, values = other_cols, 
											labels = other_labs) +
	theme_classic() + 
	theme(text = element_text(family = "Arial"), 
				legend.title = element_blank(),
				legend.key = element_rect(linewidth = c(2, 2), colour = NA),
				legend.text = element_text(family = "Arial", 
																	 size = 8, margin = margin(l = 0)),
				legend.key.height = unit(0.3, "cm"),
				legend.key.width = unit(0.3, "cm"),
				legend.key.spacing.y = unit(0.1, "cm"), 
				legend.justification = c(0, 0.325),
				axis.text.x = element_text(size = 10, hjust = 0.8),
				axis.text.y = element_markdown(size = 10), 
				axis.title.x = element_markdown(size = 10), 
				axis.title.y = element_markdown(size = 12, lineheight = 1.2)) +
	geom_hline(yintercept = 0, linetype = "dashed", linewidth = 0.25) +
	geom_signif(annotation = "*",
							xmin = 1.5, xmax = 3.5, 
							y_position = 1.85, tip_length = 0.01,
							vjust = 0.5, size = 0.25,
							textsize = 3.5, family = "Arial", colour = "black") +
	geom_segment(aes(x = 1.4, xend = 1.6, y = 1.78, yend = 1.78), 
               colour = "black", linewidth = 0.25) + 
	geom_segment(aes(x = 3.4, xend = 3.6, y = 1.78, yend = 1.78), 
               colour = "black", linewidth = 0.25) + 
	geom_signif(annotation = "*",
							xmin = 3.5, xmax = 5.5, 
							y_position = 1.45, tip_length = 0.01,
							vjust = 0.5, size = 0.25,
							textsize = 3.5, family = "Arial", colour = "black") + 
	geom_signif(annotation = "**",
							xmin = 1, xmax = 3, 
							y_position = 1.05, tip_length = 0.01,
							vjust = 0.5, size = 0.25,
							textsize = 3.5, family = "Arial", colour = "black") +
	annotation_custom(grob = grid::textGrob("\u2190 shift away", x = -0.28, y = 0.15, rot = 90,
																					gp = grid::gpar(fontsize = 9, 
																													fontface = "italic", fontfamily = "Arial"))) +
	annotation_custom(grob = grid::textGrob("shift toward \u2192", x = -0.28, y = 0.85, rot = 90,
																					gp = grid::gpar(fontsize = 9, 
																													fontface = "italic", fontfamily = "Arial"))) +
	coord_cartesian(expand = TRUE, clip = "off") + 
	theme(plot.margin = unit(c(0.2, 0.2, 0, 1), "cm"))
	
print(plt)

if (is_save == 1) {
	ggsave("data/plots/kld.png", plt,
				 height = plot_h, width = plot_h * 1, dpi = resolution)
}
```

# 6. Correlations
## 6.1. Learning performances vs Signed KL divergence (**Table S5**)

```{r}
#| label: corr_accuracy_kld 
#| echo: false 
#| warning: false 
#| output: false

data_kld <- data_kld |> 
	mutate(id = as.factor(id))

data_acc_kld <- data_acc |> 
	dplyr::select(!condition1) |> 
	left_join(data_kld, by = c("id", "group", "other_pref"))

# Healthy controls impulsive ----
data_acc_kld_hc_i <- data_acc_kld |> 
	dplyr::filter(group == "HC") |> 
	dplyr::filter(other_pref == "impulsive") |> 
	dplyr::filter(!is.na(acc) & !is.na(norm_kl))

corr_acc_kld_hc_i <- rcorr(data_acc_kld_hc_i$acc, 
													 data_acc_kld_hc_i$norm_kl, 
													 type = "spearman")

corr_acc_kld_hc_i_ci <- psych::corr.test(data_acc_kld_hc_i$acc,
																				 data_acc_kld_hc_i$norm_kl,
																				 method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(data_acc_kld_hc_i$acc,
																		data_acc_kld_hc_i$norm_kl)

bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10

# Healthy controls patient ---- 
data_acc_kld_hc_p <- data_acc_kld |> 
	dplyr::filter(group == "HC" & other_pref == "patient") |> 
	dplyr::filter(!is.na(acc) & !is.na(norm_kl))

corr_acc_kld_hc_p <- rcorr(data_acc_kld_hc_p$acc, 
													 data_acc_kld_hc_p$norm_kl, 
													 type = "spearman")

corr_acc_kld_hc_p_ci <- psych::corr.test(data_acc_kld_hc_p$acc,
																				 data_acc_kld_hc_p$norm_kl,
																				 method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(data_acc_kld_hc_p$acc,
																		data_acc_kld_hc_p$norm_kl)

bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10

# mPFC lesions impulsive ----
data_acc_kld_mpfc_i <- data_acc_kld |> 
	dplyr::filter(group == "mPFC") |> 
	dplyr::filter(other_pref == "impulsive") |> 
	dplyr::filter(!is.na(acc) & !is.na(norm_kl))

corr_acc_kld_mpfc_i <- rcorr(data_acc_kld_mpfc_i$acc,
														 data_acc_kld_mpfc_i$norm_kl,
														 type = "spearman")

corr_acc_kld_mpfc_i_ci <- psych::corr.test(data_acc_kld_mpfc_i$acc,
																					 data_acc_kld_mpfc_i$norm_kl,
																					 method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(data_acc_kld_mpfc_i$acc,
																		data_acc_kld_mpfc_i$norm_kl)

bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10

# mPFC lesions patient ---- 
data_acc_kld_mpfc_p <- data_acc_kld |> 
	dplyr::filter(group == "mPFC") |> 
	dplyr::filter(other_pref == "patient") |> 
	dplyr::filter(!is.na(acc) & !is.na(norm_kl))

corr_acc_kld_mpfc_p <- rcorr(data_acc_kld_mpfc_p$acc,
														 data_acc_kld_mpfc_p$norm_kl,
														 type = "spearman")

corr_acc_kld_mpfc_p_ci <- psych::corr.test(data_acc_kld_mpfc_p$acc,
																					 data_acc_kld_mpfc_p$norm_kl,
																					 method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(data_acc_kld_mpfc_p$acc,
																		data_acc_kld_mpfc_p$norm_kl)

bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10

# Lesion controls impulsive ----
data_acc_kld_lc_i <- data_acc_kld |> 
	dplyr::filter(group == "LC") |> 
	dplyr::filter(other_pref == "impulsive") |> 
	dplyr::filter(!is.na(acc) & !is.na(norm_kl))

corr_acc_kld_lc_i <- rcorr(data_acc_kld_lc_i$acc, 
													 data_acc_kld_lc_i$norm_kl, 
													 type = "spearman")

corr_acc_kld_lc_i_ci <- psych::corr.test(data_acc_kld_lc_i$acc,
																				 data_acc_kld_lc_i$norm_kl,
																				 method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(data_acc_kld_lc_i$acc,
																		data_acc_kld_lc_i$norm_kl)

bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10

# Lesion controls patient ----
data_acc_kld_lc_p <- data_acc_kld |> 
	dplyr::filter(group == "LC") |> 
	dplyr::filter(other_pref == "patient") |> 
	dplyr::filter(!is.na(acc) & !is.na(norm_kl))

corr_acc_kld_lc_p <- rcorr(data_acc_kld_lc_p$acc, 
													 data_acc_kld_lc_p$norm_kl, 
													 type = "spearman")

corr_acc_kld_lc_p_ci <- psych::corr.test(data_acc_kld_lc_p$acc,
																				 data_acc_kld_lc_p$norm_kl,
																				 method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(data_acc_kld_lc_p$acc,
																		data_acc_kld_lc_p$norm_kl)

bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10

# Adjust p-values for multiple comparisons 
corr_acc_kld_pvalues <- c(corr_acc_kld_hc_i$P[1, 2],
													corr_acc_kld_hc_p$P[1, 2],
													corr_acc_kld_mpfc_i$P[1, 2],
													corr_acc_kld_mpfc_p$P[1, 2],
													corr_acc_kld_lc_i$P[1, 2],
													corr_acc_kld_lc_p$P[1, 2])

corr_acc_kld_pvalues_adjusted <- p.adjust(corr_acc_kld_pvalues, method = "fdr")
```

## 6.2. Perceived similarity vs Signed KL divergence (**Table S6**)

```{r}
#| label: corr_similar_kld 
#| echo: false 
#| warning: false 
#| output: false

data_similar <- data_similar |> 
	mutate(other_pref = case_when(
		other_pref == "i" ~ "impulsive",
		other_pref == "p" ~ "patient")) |> 
	mutate(id = as.factor(id))

data_similar_kld <- data_kld |> 
	dplyr::select(!condition1) |> 
	left_join(data_similar, by = c("id", "group", "other_pref"))

# Healthy controls impulsive ---- 
data_similar_kld_hc_i <- data_similar_kld |> 
	filter(group == "HC" & other_pref == "impulsive") |> 
	dplyr::filter(!is.na(sd_similar) & !is.na(norm_kl))

corr_similar_kld_hc_i <- rcorr(data_similar_kld_hc_i$sd_similar, 
															 data_similar_kld_hc_i$norm_kl, 
															 type = "spearman")

corr_similar_kld_hc_i_ci <- psych::corr.test(data_similar_kld_hc_i$sd_similar, 
																						 data_similar_kld_hc_i$norm_kl, 
																						 method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(xVals = data_similar_kld_hc_i$sd_similar,
																		yVals = data_similar_kld_hc_i$norm_kl)

bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10

# Healthy controls patient ---- 
data_similar_kld_hc_p <- data_similar_kld |> 
	filter(group == "HC" & other_pref == "patient") |> 
	dplyr::filter(!is.na(sd_similar) & !is.na(norm_kl))

corr_similar_kld_hc_p <- rcorr(data_similar_kld_hc_p$sd_similar, 
															 data_similar_kld_hc_p$norm_kl, 
															 type = "spearman")

corr_similar_kld_hc_p_ci <- psych::corr.test(data_similar_kld_hc_p$sd_similar, 
																						 data_similar_kld_hc_p$norm_kl, 
																						 method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(xVals = data_similar_kld_hc_p$sd_similar,
																		yVals = data_similar_kld_hc_p$norm_kl)

bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10

# mPFC lesions impulsive ---- 
data_similar_kld_mpfc_i <- data_similar_kld |> 
	filter(group == "mPFC" & other_pref == "impulsive") |> 
	dplyr::filter(!is.na(sd_similar) & !is.na(norm_kl))

corr_similar_kld_mpfc_i <- rcorr(data_similar_kld_mpfc_i$sd_similar,
																 data_similar_kld_mpfc_i$norm_kl,
																 type = "spearman")

corr_similar_kld_mpfc_i_ci <- psych::corr.test(data_similar_kld_mpfc_i$sd_similar,
																							 data_similar_kld_mpfc_i$norm_kl,
																							 method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(xVals = data_similar_kld_mpfc_i$sd_similar,
																		yVals = data_similar_kld_mpfc_i$norm_kl)

bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10

# mPFC lesions patient ---- 
data_similar_kld_mpfc_p <- data_similar_kld |> 
	filter(group == "mPFC" & other_pref == "patient") |> 
	dplyr::filter(!is.na(sd_similar) & !is.na(norm_kl))

corr_similar_kld_mpfc_p <- rcorr(data_similar_kld_mpfc_p$sd_similar,
																 data_similar_kld_mpfc_p$norm_kl,
																 type = "spearman")

corr_similar_kld_mpfc_p_ci <- psych::corr.test(data_similar_kld_mpfc_p$sd_similar,
																							 data_similar_kld_mpfc_p$norm_kl,
																							 method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(xVals = data_similar_kld_mpfc_p$sd_similar,
																		yVals = data_similar_kld_mpfc_p$norm_kl)

bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10

# Lesion controls impulsive ---- 
data_similar_kld_lc_i <- data_similar_kld |> 
	filter(group == "LC" & other_pref == "impulsive") |> 
	dplyr::filter(!is.na(sd_similar) & !is.na(norm_kl))

corr_similar_kld_lc_i <- rcorr(data_similar_kld_lc_i$sd_similar, 
															 data_similar_kld_lc_i$norm_kl, 
															 type = "spearman")

corr_similar_kld_lc_i_ci <- psych::corr.test(data_similar_kld_lc_i$sd_similar, 
																						 data_similar_kld_lc_i$norm_kl, 
																						 method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(xVals = data_similar_kld_lc_i$sd_similar,
																		yVals = data_similar_kld_lc_i$norm_kl)

bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10

# Lesion controls patient ----
data_similar_kld_lc_p <- data_similar_kld |> 
	filter(group == "LC" & other_pref == "patient") |> 
	dplyr::filter(!is.na(sd_similar) & !is.na(norm_kl))

corr_similar_kld_lc_p <- rcorr(data_similar_kld_lc_p$sd_similar, 
															 data_similar_kld_lc_p$norm_kl, 
															 type = "spearman")

corr_similar_kld_lc_p_ci <- psych::corr.test(data_similar_kld_lc_p$sd_similar, 
																						 data_similar_kld_lc_p$norm_kl, 
																						 method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(xVals = data_similar_kld_lc_p$sd_similar,
																		yVals = data_similar_kld_lc_p$norm_kl)

bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10

# Adjust p-values for multiple comparisons 
corr_similar_kld_pvalues <- c(corr_similar_kld_hc_i$P[1, 2],
															corr_similar_kld_hc_p$P[1, 2],
															corr_similar_kld_mpfc_i$P[1, 2],
															corr_similar_kld_mpfc_p$P[1, 2],
															corr_similar_kld_lc_i$P[1, 2],
															corr_similar_kld_lc_p$P[1, 2])

corr_similar_kld_pvalues_adjusted <- p.adjust(corr_similar_kld_pvalues, method = "fdr")
```

## 6.3. Total lesion size vs Self baseline temporal impulsivity 

```{r}
#| label: corr_lesion_size_self_1_km
#| echo: false 
#| warning: false 

# Preparation 
data_lesion <- data_all %>%
	dplyr::select(id, group, self_1_km, self_1_ku, norm_kl_i, norm_kl_p) %>% 
	mutate(norm_kl_diff = norm_kl_i - norm_kl_p, 
				 group_num = case_when(
				 group == "HC" ~ 1,
				 group == "mPFC" ~ 2,
				 group == "LC" ~ 3)) 

lesion_size <- read.csv("lesion/lesion_size.csv", header = TRUE) |> 
	mutate(lesion = lesion / 100.0) |> 
	rename(id = ID) |> 
	left_join(data_lesion, by = "id") |> 
	mutate(group2 = "lesion")

lesion_size_mpfc <- lesion_size |> 
	filter(group == "mPFC")

lesion_size_lc <- lesion_size |> 
	filter(group == "LC")

# Across all patient participants 
corr_size_km_all <- rcorr(lesion_size$lesion,
													lesion_size$self_1_km,
													type = "spearman")

# Within mPFC lesion participants 
corr_size_km_mpfc <- rcorr(lesion_size_mpfc$lesion,
													 lesion_size_mpfc$self_1_km,
													 type = "spearman")
```

## 6.4. Total lesion size vs Contrased signed KL divergence (impulsive - patient)

```{r}
#| label: corr_lesion_size_kld_diff 
#| echo: false 
#| warning: false 

# Across all patient participants 
corr_size_kld_diff_all <- rcorr(lesion_size$lesion,
																lesion_size$norm_kl_diff,
																type = "spearman")

# Within mPFC lesion participants
corr_size_kld_diff_mpfc <- rcorr(lesion_size_mpfc$lesion,
																 lesion_size_mpfc$norm_kl_diff,
																 type = "spearman") 
```

## 6.5. Total lesion size vs Baseline preference uncertainty (within LC group)

```{r}
#| label: corr_lesion_size_self_1_ku 
#| echo: false 
#| warning: false 

corr_size_ku_lc <- rcorr(lesion_size_lc$lesion,
												 lesion_size_lc$self_1_ku,
												 type = "spearman")

corr_size_ku_lc_ci <- psych::corr.test(lesion_size_lc$lesion,
																			 lesion_size_lc$self_1_ku,
																			 method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(xVals = lesion_size_lc$lesion,
																		yVals = lesion_size_lc$self_1_ku)
bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10
```

## 6.6. Signed KL divergence (impulsive vs patient) (**Table SX**)

```{r}
#| label: corr_kld_ip 
#| echo: false 
#| warning: false

# Preparation 
data_kld_i <- data_kld |> 
	filter(other_pref == "impulsive") |> 
	rename(norm_kl_i = norm_kl)

data_kld_p <- data_kld |> 
	filter(other_pref == "patient") |> 
	rename(norm_kl_p = norm_kl)

data_corr_kld <- data_kld_i |> 
	left_join(data_kld_p, by = c("id", "group")) |> 
	dplyr::select(id, group, norm_kl_i, norm_kl_p) |> 
	filter(!is.na(norm_kl_i) & !is.na(norm_kl_p))

# Overall  
corr_kld <- rcorr(data_corr_kld$norm_kl_i,
									data_corr_kld$norm_kl_p,
									type = "spearman")

corr_kld_ci <- psych::corr.test(data_corr_kld$norm_kl_i,
																data_corr_kld$norm_kl_p,
																method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(xVals = data_corr_kld$norm_kl_i,
																		yVals = data_corr_kld$norm_kl_p)

bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10

# Healthy controls 
data_corr_kld_hc <- subset(data_corr_kld, group == "HC")

corr_kld_hc <- rcorr(data_corr_kld_hc$norm_kl_i, 
										 data_corr_kld_hc$norm_kl_p, 
										 type = "spearman")

corr_kld_hc_ci <- psych::corr.test(data_corr_kld_hc$norm_kl_i,
																	 data_corr_kld_hc$norm_kl_p,
																	 method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(xVals = data_corr_kld_hc$norm_kl_i,
																		yVals = data_corr_kld_hc$norm_kl_p)

bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10

# mPFC lesions 
data_corr_kld_mpfc <- subset(data_corr_kld, group == "mPFC")

corr_kld_mpfc <- rcorr(data_corr_kld_mpfc$norm_kl_i, 
											 data_corr_kld_mpfc$norm_kl_p,
											 type = "spearman")

corr_kld_mpfc_ci <- psych::corr.test(data_corr_kld_mpfc$norm_kl_i,
																		 data_corr_kld_mpfc$norm_kl_p,
																		 method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(xVals = data_corr_kld_mpfc$norm_kl_i,
																		yVals = data_corr_kld_mpfc$norm_kl_p)

bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10

# Lesion controls 
data_corr_kld_lc <- subset(data_corr_kld, group == "LC")

corr_kld_lc <- rcorr(data_corr_kld_lc$norm_kl_i, 
										 data_corr_kld_lc$norm_kl_p,
										 type = "spearman")

corr_kld_lc_ci <- psych::corr.test(data_corr_kld_lc$norm_kl_i,
																	 data_corr_kld_lc$norm_kl_p,
																	 method = "spearman")

set.seed(1213)
rho_samples <- spearmanGibbsSampler(xVals = data_corr_kld_lc$norm_kl_i,
																		yVals = data_corr_kld_lc$norm_kl_p)

bf10 <- computeBayesFactorOneZero(rho_samples$rhoSamples,
																	whichTest = "Spearman",
																	priorParameter = 1)
bf01 <- 1 / bf10

# Adjust p-values for multiple comparisons 
corr_kld_p <- c(corr_kld$P[1, 2],
								corr_kld_hc$P[1, 2],
								corr_kld_mpfc$P[1, 2],
								corr_kld_lc$P[1, 2])

corr_kld_p_adjusted <- p.adjust(corr_kld_p, method = "fdr")
```

# 7. Lesion analysis 
